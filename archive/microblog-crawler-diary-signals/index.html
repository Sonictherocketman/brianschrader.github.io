<!DOCTYPE html>
<html>
<head>
	<title>Microblog Crawler Diary: Signals - BiteofanApple</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
	<link href='http://fonts.googleapis.com/css?family=Average' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="/bin/CSS/stylesheet.css">
	<link rel="stylesheet" type="text/css" href="/bin/CSS/mobile.css">
	<!--
	<link rel="shortcut icon" href="http://images.biteofanapple.com/misc/favicon.ico">
	<link rel="icon" href="http://images.biteofanapple.com/misc/favicon.ico">
	<link rel="apple-touch-icon-precomposed" href="http://images.biteofanapple.com/misc/apple-touch-icon-precomposed.png"/>  
	-->
	<meta property="og:title" content="Microblog Crawler Diary: Signals" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="http://brianschrader.com/archive/microblog-crawler-diary-signals/" />	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	  ga('create', 'UA-48095792-1', 'auto');
	  ga('send', 'pageview');
	</script>
</head>
<body>
<div id="content">
	<div id="title-bar">
		<!-- Desktop Nav -->
		<span>
			<!-- Name and Author -->
			<span class="menuBarItem" style="margin-left: 10px; font-size:2em;"><a href="/">BiteofanApple</a></span>
			<!-- Links -->
			<span class="menuBarItem" style="margin-left: 40px;"><a href="/archive/">Archive</a></span>
			<span class="menuBarItem"><a href="/about/">About</a></span>
			<span class="menuBarItem"><a href="https://github.com/Sonictherocketman">Code</a></span>
			<span class="menuBarItem"><a href="http://www.twitter.com/SonicRocketman/">Twitter</a></span>
			<br>
			<span class="menuBarItem" style=" position:absolute; margin-top:-80px; margin-left:10px; font-size:10pt; font-style:italic;">by <a href="/about/">Brian Schrader</a></span>
		</span>	
		<!-- Mobile Nav -->
		<div class="mobile-nav">
			<!-- Name and Author -->
			<div style="text-align:center; margin-top:-20pt;">
				<span class="" style="font-size:2em;"><a href="/">BiteofanApple</a></span>
			</div>
			<!-- Links -->
			<div style="margin-top:2%;">
				<span class="mobileMenuBarItem" style=""><a href="/archive/">Archive</a></span>
				<span class="mobileMenuBarItem"><a href="/about/">About</a></span>
				<span class="mobileMenuBarItem"><a href="https://github.com/Sonictherocketman">Code</a></span>
				<span class="mobileMenuBarItem"><a href="http://www.twitter.com/SonicRocketman/">Twitter</a></span>
			</div>
		</div>	
	</div>
	<div id="post-list">
		<article>
			<div class="post">
				<div class="article-title">
					<h1><a href="/archive/microblog-crawler-diary-signals/">Microblog Crawler Diary: Signals</a></h1>
					<small style="font-style:italic;">Posted on Tue, 24 Feb 2015 at 03:07 AM</small>
				</div>
				<div class="article-content">
					<p>I've been turning this issue over in my head all day, and I think I've got a workable solution. Here's the problem: Since the web-app and the crawler are two separate processes (completely unrelated since the crawler is a cron job and the web-app is running under mod_wsgi) they don't have any way to communicate. Normally this isn't a problem since they don't really need to communicate. The crawler does its thing, and inserts records into a cache, and the web-app reads from the cache. Simple. However, my goal now is to support server notifications for new posts. That is, when a user posts a message, any service that has registered for notifications will be pinged to let them know that a new post is available. That way the server doesn't have to poll URLs constantly to receive to-the-minute updates.</p>
<p>Sending these messages is simple. Receiving them is hard. Upon receiving a message, the app server needs to notify the crawler that it should go and fetch a given URL (and possibly even a given item). Interrupting a process that is completely unrelated and that could be right in the middle of something else, is not an easy problem to solve. Here's my solution though. Currently, when the crawler starts up it checks to see if there is a <code>pid</code> file in the system's temp directory. If there is, then it quits, if not it creates one and sets about its business. The pid file tells the crawler that an instance of itself is already running. The web-app will read the pid from that file, write the link it's supposed to crawl to another file, and send a signal to the crawler process with that pid. </p>
<p>The crawler will have a handler for that signal that will then pause the crawling, (if it is being done) read in the link that is supposed to be crawled, and do so. Once it is done crawling, it records the link, and inserts the new post into the cache. The crawler then resumes its job of crawling the list of links, and if that link is the same as the link recorded in the signal handler, then it moves on without processing it (since it has already done so). </p>
<p>It does seem a bit primitive, but it should be straight forward to implement. With this implemented, the crawler can increase its default crawling interval and fall back to just being notified if anything new comes along.</p>
<hr />
<p><strong>Side note:</strong> I will have to be careful what signals are allowed to pass to the crawler. If unchecked, spammers could easily stop the crawler dead in its tracks (since I would be essentially sending OS interrupts for every message received). To mitigate this, the web-app will keep a whitelist of servers it has requested updates from and only accept messages from those servers. </p>				
				</div>
			</div>
		</article>
		<div style="text-align:center;">
			<div class="article-content">
				<span style="font-style:italic;">Subscribe to the <a href="/rss">RSS Feed</a>. Check out my code on <a href="http://github.com/sonictherocketman/">GitHub</a></span>
			</div>
			<div class="article-content">
				<span style="font-size:small;">
					<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
						<img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" />
					</a>
				<br />
				<span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">BiteofanApple</span> is licensed under a 
				<a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
			</div>
		</div>
	</div>
</div>
</body>
</html>
