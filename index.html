<!DOCTYPE HTML>
<html>
<head>
	<title>Home - BiteofanApple</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<link rel="stylesheet" type="text/css" href="/bin/CSS/stylesheet.css">
	<link rel="stylesheet" type="text/css" href="/bin/CSS/mobile.css">
  <link rel="icon" type="image/png" href="//www.gravatar.com/avatar/11b074a636e00292c98e3e60f7e16595?size=30">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml"/>
  <link rel="alternate" type="application/json" title="JSON Feed" href="/feed.json"/>
	<meta property="og:type" content="article" />
</head>
<body>
	<div id="content">
		<div id="title-bar">
			<!-- Desktop Nav -->
			<!-- Name and Author -->
			<span class="menuBarItem" style="margin-left: 10px; font-size:2em;"><a href="/">BiteofanApple</a></span>
				<!-- Links -->
				<span class="menuBarItem" style="margin-left: 30px;"><a href="/archive/">Archive</a></span>
				<span class="menuBarItem"><a href="/about/">About</a></span>
				<span class="menuBarItem"><a href="https://github.com/Sonictherocketman">Code</a></span>
			  <span class="menuBarItem"><a href="http://microblog.brianschrader.com">Microblog</a></span>
			  <span class="menuBarItem"><a href="http://photos.brianschrader.com">Photos</a></span>
			  <span class="menuBarItem"><a href="//pinboard.in/u:sonicrocketman/public/">Links</a></span>
				<br>
				<span class="menuBarItem" style=" position:absolute; margin-top:-80px; margin-left:10px; font-size:10pt; font-style:italic;">by <a href="/about/">Brian Schrader</a></span>
			</span>

			<!-- Mobile Nav -->
			<div class="mobile-nav">
				<!-- Name and Author -->
				<div style="text-align:center; margin-top:-20pt;">
					<span class="" style="font-size:2em;"><a href="/">BiteofanApple</a></span>
				</div>
				<!-- Links -->
				<div style="margin-top:2%;">
					<span class="mobileMenuBarItem" style=""><a href="/archive/">Archive</a></span>
					<span class="mobileMenuBarItem"><a href="/about/">About</a></span>
			    <span class="menuBarItem"><a href="http://microblog.brianschrader.com">Microblog</a></span>
				</div>
			</div>
		</div>	<!-- End title-bar -->
		<div id="post-list">
			<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/primitive-tech-is-here-for-the-long-haul/">
					Primitive Tech is Here for the Long Haul
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Fri, 24 Nov 2017 at 02:46 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>John's <a href="https://primitivetechnology.wordpress.com/2017/11/24/new-area-starting-from-scratch/">most recent Primitive Technology blog post</a> has me pretty excited. The new video is great, as his videos tend to be, but the post mentions something a bit more exciting.</p>
<blockquote>
<p>I bought a new property to shoot primitive technology videos on. The new area is dense tropical rainforest with a permanent creek. Starting completely from scratch, my first project was to build a simple dome hut and make a fire.</p>
</blockquote>
<p>This is just me speculating here, but he wouldn't be buying a whole new plot of land to shoot videos on if he wasn't planning on making more videos long term. While I never had any reason to believe he'd be stopping anytime soon, such a big purchase is great news for him, his channel, and fans like me.</p>
<p><a href="https://primitivetechnology.wordpress.com/2017/11/24/new-area-starting-from-scratch/">Primitive Technology Blog &#8594;</a></p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/the-fcc-moves-to-dismantle-net-neutrality/">
					The FCC Moves to Dismantle Net Neutrality
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Thu, 23 Nov 2017 at 09:18 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p><a href="https://techcrunch.com/2017/11/21/fcc-officially-moves-to-unwind-net-neutrality-rules/amp/">Jonathan Shieber for TechCrunch &#8594;</a></p>
<blockquote>
<p>Federal Communications Commission Chairman Ajit Pai today made good on his long-standing pledge to tackle regulations established in the last administration designed to protect the distribution of internet content.</p>
<p>On Tuesday, Pai distributed to the other commissioners at the FCC a draft of his suggested rule changes under the auspices of the ‚ÄúRestoring Internet Freedom Order.‚Äù</p>
<p>The move sets up a December 14 vote at the FCC that could have broad ramifications for the entire internet. Under the rules established by the Obama administration, internet providers are required to provide open access to their networks for all digital content.</p>
</blockquote>
<p>I'm really sad to see the FCC going forward with their plan to dismantle the Net Neutrality protections. What's worse is that Ajit Pai seems to know full well what this will mean for the web, and seemingly no amount of public comment against his proposal can disuade him.</p>
<p>It seems like the only recourse we really have now is either to chip away at Ajit Pai's resolve with public comments before the December vote, or wait for some act of Congress to reverse the decision: something I can't even imagine them doing.</p>
<p><a href="https://act.eff.org/action/congress-don-t-sell-the-internet-out">Help Protect the Internet by Contacting Your Representative &#8594;</a></p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/mygenerank-behind-the-scenes-of-the-newest-researchkit-app/">
					MyGeneRank: Behind the Scenes of the Newest ResearchKit App
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Wed, 25 Oct 2017 at 10:11 AM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>I'm super excited to announce that <a href="https://mygenerank.scripps.edu">MyGeneRank</a>, an app that I've been working on at my jobby-job at the <a href="https://www.stsiweb.org">Scripps Translational Science Institute</a> for a year and a half, is now available on the <a href="TODO">App Store</a>, and the source code is <a href="https://github.com/TorkamaniLab/mygenerank-api">available on GitHub</a>!</p>
<p>I've wanted to talk about this project for a while, I've written many unpublished posts about how it works, and now the time is finally right. If you're looking for the scientific or research parts, I'm going to leave that to <a href="http://www.biorxiv.org/content/early/2017/01/19/101519">the paper we published</a>. I want to talk more about my experiences and what I've learned in building the system.</p>
<p>As a quick overview: MyGeneRank is a ResearchKit based research study app aimed at providing users with their Genetic Risk for diseases, and measuring their reactions to this information. The first disease being Coronary Artery Disease. I'm definitely not a doctor, statistician, or biologist, and everyone else on the team handled all of the scientific work, but I am a Software Developer and I worked on the vast majority of the <a href="https://github.com/TorkamaniLab/mygenerank-api">API</a>, Computation Engine, <a href="https://mygenerank.scripps.edu">Website</a>, and <a href="TODO">iOS App</a> development, DevOps, and System Administration as the sole developer. I learned a hell of a lot during the last year and a half and looking back, I'm not sure how I even got this far. Since the source code is available, at least for the API, (iOS source is coming) so now you too can see my mistakes and pass judgement! üéâ</p>
<h2>From a Technical Perspective</h2>
<p>Vaguely, MyGeneRank's backend has three main parts: a database (<a href="https://twitter.com/tonymillion/status/417213069572714496">Postgres</a>), a Django REST API (which is open source), and what we've called a Computation Engine. All of it runs in-house, maintained by yours truly. The API and database are pretty self-explanatory, and the "engine" is really a Celery cluster and Redis queue which runs, among other things, a series of Python wrapped command-line tools and custom R scripts to calculate a person's genetic risk given their <a href="https://www.23andme.com">23andMe</a> <a href="https://api.23andme.com/docs/reference/">genotype data</a>. While the computation stuff is a sort of special case (what with the CLI tools and R scripts), the API's design goal was to be as industry-standard practice as possible. It's 90% covered with tests, leverages Travis-CI, uses <a href="http://www.django-rest-framework.org">DRF</a> and <a href="http://docs.celeryproject.org/en/latest/index.html">Celery</a> for the vast majority of its work, and everything runs in Docker containers on CentOS.</p>
<p>If this stack sounds familiar to readers of this site, then you're catching on. In my post about <a href="/archive/adventurers-codex-the-stack/">Adventurer's Codex's stack</a> I spelled out basically the same setup. In truth the stack for AC was heavily influenced by MyGeneRank. I took everything I learned building MyGeneRank and ported it to Adventurer's Codex a year later. That's how developers work, we do things once, then copy-pasta it everywhere.</p>
<h2>Scientific Computing at Scale: Performance and Throughput</h2>
<p>MyGeneRank has very demanding computational needs. Currently, we have <strong>178 cores and almost a terabyte of RAM</strong> powering the app and its backend. Turns out, calculating a person's genetic risk, even using genotyping data and not <a href="https://www.illumina.com/science/technology/next-generation-sequencing.html">NGS</a>, requires a lot of computational power. Scaling this kind of intense scientific computation for public use was one of the most challenging (and enjoyable) parts of the project. But even now I don't really have many concrete answers to the problem other than the twin suggestions: add more cores and make your work as functional and therefore parallel as possible.</p>
<h4>Into the Weeds for a Bit</h4>
<p>The calculations needed to return a given user's genetic risk score can be broken into roughly 110 individual tasks and is mostly trivial to parallelize. What takes ~110 minutes of CPU time per user can be done in 3.5-4 minutes of wall time on our current system, but as any web developer knows, even that kind of processing time is hard to scale. The first couple tasks are run in series and then two chunks of tasks are run in parallel. The first chunk contains a single task which calculates the user's genetic ancestry, and the other chunk has 52 two-part tasks. This means that at any one time, 53 tasks per user are running during the bulk of the computation. These first 52 tasks take ~1.5-1.8 minutes each depending on which chromosome they're processing (<a href="https://www.youtube.com/watch?v=C906lbkcYug">some are bigger than others</a>) and then the second batch takes about the same amount of time per chunk. The genetic ancestry takes ~3.2 minutes. Once all of these tasks are complete there's a final step that calculates the actual risk score, which is fairly instantaneous. What this means is that the time from start to finish for a given user's score is parallelize-able up to ~54 cores, then it's core speed that matters, which is harder to improve. The extra cores we have allows us to calculate more scores at once, but <strong>even with our huge core count, we can only calculate ~3-4 users' scores at a time</strong>. The good news is that all of the steps are really good at keeping memory use low; CPUs are the bottleneck here.</p>
<p>Improving API and Website level performance is much more straightforward than doing the same for the backend. Like most sites, MyGeneRank sits behind an Nginx Reverse Proxy with some out of the box microcaching for popular pages.</p>
<p>At time of writing, I'm not sure what the load will be like when we finally announce the study publicly, but I've spent a lot of time worrying about and trying to ensure that the site can handle the loads we hope for. There's been a <a href="https://www.macworld.com/article/2895941/stanfords-researchkit-app-gained-more-users-in-24-hours-than-most-medical-studies-find-in-a-year.html">lot</a> of <a href="https://www.fastcompany.com/3058125/in-its-first-year-has-apples-researchkit-revolutionized-medical-research">interesting</a> <a href="http://parkinsonsnewstoday.com/2016/03/28/parkinsons-mpower-app-celebrates-milestone-12000-registered-users-upgrade-apple-product-launch/">news</a> and <a href="https://stories.appbot.co/how-i-got-2-3m-app-downloads-without-spending-a-cent-on-marketing-f4823b6bc779">blog posts</a> over the years about what kind of download numbers an app, and especially a research app can expect, and I wanted to build MyGeneRank with those kinds of numbers in mind. Once the project has hit its first month I'm going to do a retrospective on how it all went and we'll see if my performance enhancements were enough.</p>
<h2>Lessons Learned</h2>
<p>There's a lot of little things that I've learned in building MyGeneRank (and later Adventurer's Codex). When we started, I'd worked on a few toy iOS apps and  a few corporate web projects, but MyGeneRank turned out to be of a completely different scale.</p>
<p>Before MyGeneRank, I'd never used Django, or Django REST. I'd heard of them, and had a friend who used them, but aside from a few <a href="https://github.com/HyperTextCoffeePot/HyperTextCoffeePot">toy projects</a> in Flask, my web experience was in front-ends or Java/Spring (and I guess PHP). My work at that time was mostly in writing <a href="https://github.com/TorkamaniLab/metapipe#metapipe">analysis pipelines in Python</a> and since it's my preferred language, I wanted to use it for MyGeneRank. To this day, the structure of the API project is a little wonky and apps aren't where they should be; both are cruft from those early days. I try not to worry about it too much since I was learning as I went, and this kind of legacy cruft is impossible to avoid unless you knew everything at the start, and we most assuredly didn't. I can say that Django/Django REST has shown me just how boring building websites really is because it does most of it for you automatically and supports anything you'd ever really need right out of the box; you should definitely use it.</p>
<p>The modern web is really complex and there's a reason that it takes so many skilled developers to build large systems. Server setup, administration, DevOps, reporting, and application development are all sub-disciplines unto themselves (which is why they're separate jobs at most places). And I've found that jumping in and out of these different worlds can result in a sort of Programmer's Jet Lag as your body adjusts to the new environment after spending days in a completely different one.</p>
<p>On the native side, Apple's frameworks can be fun to use, and their OS frameworks, documentation, and user guides are world-class, but their tooling can also be frustrating and slow at times. The iOS app is written entirely in Swift and that has had some major effects on the development. Swift's tooling is still very new and the language has changed drastically since it came out. Having worked in both, I can say that, while I do enjoy Swift, nothing has made me appreciate the maturity of Python more.</p>
<p>Overall, my advice for building these kinds of systems is the same as when I wrote a <a href="/archive/adventurers-codex-behind-the-curtain/">similar post about Adventurer's Codex</a>:</p>
<blockquote>
<p>...ask people who've done it before... The internet is great, but it's actually pretty difficult to find out how to design modern web systems from scratch with just a vague notion and Google.</p>
</blockquote>
<p>MyGeneRank, to me, represents my passing from a junior to a senior developer in a lot of ways. By no means have I learned all there is to know, but having now built two large web projects, and being the  sole developer for one of them, I feel like a different person from the one who started the project a year and a half ago. I'd love to know what you all think of the source, and if you find a bug, file an issue please.</p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/oauth-over-xmpp/">
					OAuth Over XMPP
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Tue, 24 Oct 2017 at 06:24 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>As <a href="/archive/adventurers-codex-xmpp/">I've said before</a>, <a href="https://adventurerscodex.com">Adventurer's Codex</a> uses XMPP for it's real-time features. During development we ran into a couple of interesting challenges with integrating such a mature system with our new-ish web stack, one of which was User Authentication.</p>
<p>The majority of Adventurer's Codex uses an OAuth Provider model for user authentication but Ejabberd (our XMPP server) requires that the username and password be sent at connection time. Obviously we didn't want to have two different auth schemes to support, and we didn't want our client app to store any passwords (hence OAuth). We spent a while hunting for different possible solutions, and in the end we stumbled into a really simple one.</p>
<p>Ejabberd allows for authentication to be handled by an external script, which allows us to use our core database as the auth backend. We could, in principle, use a Django management command to make a call to our database, hash the password that we were given by the client and compare it to the one stored in our database, but not only is that a lot of work and error prone, it's too coupled to our database layer, and it still required the client to store the user's password.</p>
<p>In the end we went with what might seem like the obvious solution: just keep using OAuth. After the client receives the initial user data at load time, it sends the same OAuth token as the password along with the user's XMPP JID to Ejabberd. Ejabberd then calls out to an external script which makes an HTTP request to our API to see if the user exists and that the token is valid. Clean and simple.</p>
<p><img alt="A visualization of the OAuth over XMPP process." src="/images/blog/xmpp-auth.svg" /></p>
<p>There's a few major advantages to using this method. First, The client no longer has to store user passwords, which not only makes our implementation simpler, but also protects our users from a whole host of attacks. Second, the user's XMPP session is now bound to the same limits as the rest of their access to the site which greatly simplifies permissions handling. Third, and perhaps the most interesting is that Ejabberd is no longer tied to either the Django CLI or the database and can be spun off as essentially a separate microservice on another machine.</p>
<p><a href="https://gist.github.com/Sonictherocketman/aefd78575280978af0562a0b9841a903">Check out the Ejabberd Auth Script &#8594;</a></p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/todolist-update/">
					todolist update
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Tue, 10 Oct 2017 at 03:35 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>Over the last week, I've made some changes to <a href="//gist.github.com/Sonictherocketman/77dd6cd8fd907dbbc00031acb08f3ba0">my todolist script</a>: I've cleaned up the printing a bit and removed the temp file.</p>
<p><img alt="todolist terminal output" src="/images/blog/todolist-update.png" /></p>
<p>I had to remove the temp file because it was actually causing performance problems with BBEdit. Since the temp file came into and out of existence every few seconds, BBEdit's project view would dutifully redraw the project file list twice in quick succession, wasting quite a bit of CPU power<sup>1</sup>, and sometimes causing my MacBook's fan to spin up. Now that the temp file is gone, that problem is too.</p>
<div class="footnote">
<sup>1. </sup>I'm not sure why BBEdit needs so much power to redraw the project list and I've reached out to their support. Hopefully they can resolve the issue. At the very least my script is a little more well behaved so it's no longer an issue.
</div>

<p><a href="//gist.github.com/Sonictherocketman/77dd6cd8fd907dbbc00031acb08f3ba0">todolist &#8594;</a></p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/mini-rant-about-documentation/">
					Mini-Rant About Documentation
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Mon, 09 Oct 2017 at 03:31 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>I want to talk about documentation. iOS<sup>1</sup>, Nginx, Python, DRF, Django, Celery, and Postgres have excellent documentation, but documentation only helps when your question is "How does this thing work and what does it do?" Documentation, at least code level docs, are useless when it comes to figuring out what you need in the first place. Celery can tell you how to use Celery, but it isn't as great at telling you why you might need it. I've become convinced that user guides are as, if not more, important than code level documentation, and we as a community need more of them.</p>
<div class="footnote">
1. For their credit, iOS and really all of Apple's developer resources have excellent user guides that explain not only how to use a thing, but why and where you might need it (thinking about it, this could be because iOS and macOS have been around long enough to develop these kinds of docs).
</div>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/todolist/">
					todolist
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Thu, 28 Sep 2017 at 02:28 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>I've <a href="/archive/todos-as-a-templating-system/">talked before</a> about how I use <code>TODO</code> comments in my code to lay out what I want to do before actually doing it. To help me keep track of all of these TODOs in my code I wrote a <a href="https://gist.github.com/Sonictherocketman/77dd6cd8fd907dbbc00031acb08f3ba0">little script yesterday</a> and I've put it on Github for anyone who's interested.</p>
<p>The script looks through all of the code (by default Python code) in a given destination directory, greps for the <code>TODO</code> comments, and prints them nicely in a constantly updated list in the terminal. The output looks like this:</p>
<p><img alt="Todolist Terminal Window" src="/images/blog/todolist-terminal.png" /></p>
<p>Writing this script I learned a couple of new things about terminal commands like how to clear the screen without deleting the scrollback or just printing newlines (i.e. what <code>clear</code> does). I've put the script in my <code>/usr/local/bin</code> and called it <code>todolist</code> so now I can invoke it from anywhere and get a nice little list of what I've put off working on.</p>
<p><a href="https://gist.github.com/Sonictherocketman/77dd6cd8fd907dbbc00031acb08f3ba0">todolist on Github &#8594;</a></p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/accidental-devops/">
					Accidental DevOps
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Tue, 26 Sep 2017 at 12:30 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>Since I became a developer, I've always worked on small (3-5) or single-person teams. Even at my current job, I'm the the lead and only full-time developer. In more recent projects (including <a href="https://adventurerscodex.com">Adventurer's Codex</a>) this means that I'm the DevOps guy and System Admin as well. I'm by no means an expert in either, but I can do both.</p>
<p>I started learning how to manage and administer servers when I started this site back in 2012. Back then I never thought that all of those hours spent configuring Apache and PHP would lead to anything, but those countless hours of frustration taught me the basics. Fast-forward 5 years and I'm developing three major projects (two unannounced) and I'm DevOps and SysAdmin for all three. It's crazy to think about.</p>
<p>I'd highly recommend any new developers to follow the same general path I did: start a project or blog and learn to deploy it yourself. I started with a cheap old-style webhost and FTP, and slowly moved to managing the whole stack on Linode. I'm using Docker on new projects, and for now, I'm scripting my own deploys (though this could change soon if I migrate one project to Ansible).</p>
<p>As developers it's sometimes easy to forget that we write software that actually runs on some actual hardware in some actual datacenter somewhere. Knowing how to do many of the things that DevOps and SysAdmins do will not only make you a better developer, it gives you the ability to do more on your own. You often don't need tons of layers of software to deploy yours if you know how to do it from the ground up (especially if it's a smaller project). Those tools make it easier sure, but they're not required.</p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/getting-back-on-the-horse/">
					Getting Back on the Horse
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Mon, 25 Sep 2017 at 04:20 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>It's been a while since my last post. This whole summer has been an unusually quiet here, and while a number of personal issues have cropped up this summer that derailed me from blogging, I've really just gotten out of the habit of writing regularly. This is me forcing myself back onto that horse. I've got some exciting news coming, and between work and Adventurer's Codex, I've been keeping myself way too busy.</p>
<p>On the <a href="https://adventurerscodex.com">Adventurer's Codex</a> front: we're in the middle of a large refactor caused by our ongoing migration to Webpack which should hopefully fix a bug caused by our fairly primitive current build and deploy system. We're starting to see the light at the end of the tunnel now, and hopefully it shouldn't take much longer before we're back to writing new, cool features. The original build and deploy system was basically a lot of manual work and a shell script. When we wrote it, I had no idea what Webpack was or how to deploy a modern front-end app, now I do. That's what happens when you learn on the go; sometimes you have to step back and fix your past mistakes.</p>
<p>In my dwindling spare time, I've been working on another project that I hope to announce soon, so look for more to come there.</p>
		</div>
	</div>
</article>
<article>
	<div class="post">
		<div class="article-title">
			<h1><a href="/archive/todos-as-a-templating-system/">
					TODOs as a Templating System
				</a>
			</h1>
			<small style="font-style:italic;">Posted on Mon, 31 Jul 2017 at 03:24 PM </small>
		</div> <!-- End article-title -->
		<div class="article-content">
			<p>When I sit down to start a new feature or project the blank page or empty function can be extremely intimidating; a void of infinite complexity. I'm sure lots of developers do this, and maybe most don't realize it, but I've found that <code>TODO</code> comments are super useful in helping to abstract away nitpicky details and focus on the overall purpose of the code as I'm writing it. Let's say that we want to validate some parameters from an HTTP request and kick off a background task to send an email to a list of requested users. First off, we need to handle the request and kick off the task, but there's a bunch of validation and database queries we need to make before we can do that, and we haven't even written the task function yet, that's where <code>TODOs</code> come in.</p>
<pre><code>class MassEmailView(APIView)
    # TODO: check if user has permission to send mass mail
    def post(self, request):
        # TODO: Get users from the request
        users = []
        for user in users:
            # TODO: send the message
            pass
        return Response(None, status=200)
</code></pre>
<p>Right off the bat I know that I need to get a list of users and do something with each of them. In a lot of ways I'm basically writing pseudo-code and slowly filling in the blanks with real code. Next, let's say we write the background task.</p>
<pre><code># ---- tasks.py ----
@shared_task
def send_email(user, subject, message_text):
    email.send(user.email, subject, text=message_text)

# ---- views.py ----
class MassEmailView(APIView)
    # TODO: check if user has permission to mass send mail
    def post(self, request):
        # TODO: Get users, subject, and text from the request
        users = []
        subject = ''
        text = ''
        for user in users:
            tasks.send_email.delay(user, subject, text)
        return Response(None, status=200)
</code></pre>
<p>Slowly the code is coming together. I've written the background task and updated my view. The basic structure is there, but I haven't done the work of parsing the request or any error handling, so let's move on to that.</p>
<pre><code># ---- tasks.py ----
@shared_task
def send_email(user, subject, message_text):
    email.send(user.email, subject, text=message_text)

# ---- views.py ----
class MassEmailView(APIView)
    @authentication_classes((SessionAuthetication,))
    @permission_classes((IsAdmin,))
    def post(self, request):
        try:
            users = [
                User.objects.get(username=username)
                for username in request.POST['users'].split(',')
            ]
        except ObjectDoesNotExist:
            return Response(INVALID_USER_RESPONSE, status=400)

        subject = request.POST['message_text']
        text = request.POST['message_text']
        for user in users:
            tasks.send_email.delay(user, subject, text)
        return Response(None, status=200)
</code></pre>
<p>Now that we're done, it's clear that the <code>TODO</code> comments were hiding quite a bit of complexity, but the overall structure is the same. Just because our code is read by the computer from top to bottom doesn't mean we have to write it that way. Sometimes it helps to start with a rough outline of the whole picture, and slowly color it in bit by bit.</p>
<p><link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
<script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script></p>
		</div>
	</div>
</article>
			<div class="post">
				<div class="article-title"><a href="/archive/"><h3>Archive</h3></a><a href="/rss.xml"><h3>RSS</h3></a></div>
			</div>
			<div style="text-align:center;">
        <div class="article-content">
          <span style="font-size:small;">
            <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
              <img alt="Creative Commons License" style="border-width:0" src="/images/misc/cc-license.png" />
            </a>
          </div>
				</div>
			</div>
		</div> <!-- End post-list -->
	</div> <!-- End content -->
</body>
</html>
